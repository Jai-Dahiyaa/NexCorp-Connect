pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('backend') {
                    sh 'npm ci'
                }
            }
        }

        stage('Run App with Env') {
            steps {
                withCredentials([
                    string(credentialsId: 'DATABASE_URL', variable: 'DATABASE_URL'),
                    string(credentialsId: 'REDIS_URL', variable: 'REDIS_URL'),
                    string(credentialsId: 'EMAIL_USER', variable: 'EMAIL_USER'),
                    string(credentialsId: 'EMAIL_PASS', variable: 'EMAIL_PASS'),
                    string(credentialsId: 'GOOGLE_CLIENT_ID', variable: 'GOOGLE_CLIENT_ID'),
                    string(credentialsId: 'GOOGLE_CLIENT_SECRET', variable: 'GOOGLE_CLIENT_SECRET'),
                    string(credentialsId: 'GOOGLE_CALLBACK_URL', variable: 'GOOGLE_CALLBACK_URL'),
                    string(credentialsId: 'GITHUB_CLIENT_ID', variable: 'GITHUB_CLIENT_ID'),
                    string(credentialsId: 'GITHUB_CLIENT_SECRET', variable: 'GITHUB_CLIENT_SECRET'),
                    string(credentialsId: 'GITHUB_CALLBACK_URL', variable: 'GITHUB_CALLBACK_URL'),
                    string(credentialsId: 'ACCESS_TOKEN', variable: 'ACCESS_TOKEN'),
                    string(credentialsId: 'ACCESS_EXPIRE', variable: 'ACCESS_EXPIRE'),
                    string(credentialsId: 'REFRESH_TOKEN', variable: 'REFRESH_TOKEN'),
                    string(credentialsId: 'REFRESH_EXPIRE', variable: 'REFRESH_EXPIRE'),
                    string(credentialsId: 'CLOUDINARY_NAME', variable: 'CLOUDINARY_NAME'),
                    string(credentialsId: 'CLOUDINARY_API_KEY', variable: 'CLOUDINARY_API_KEY'),
                    string(credentialsId: 'CLOUDINARY_API_SECRET', variable: 'CLOUDINARY_API_SECRET')
                ]) {
                    dir('backend') {
                        sh '''
                        export DATABASE_URL=$DATABASE_URL
                        export REDIS_URL=$REDIS_URL
                        export EMAIL_USER=$EMAIL_USER
                        export EMAIL_PASS=$EMAIL_PASS
                        export GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
                        export GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
                        export GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL
                        export GITHUB_CLIENT_ID=$GITHUB_CLIENT_ID
                        export GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET
                        export GITHUB_CALLBACK_URL=$GITHUB_CALLBACK_URL
                        export ACCESS_TOKEN=$ACCESS_TOKEN
                        export ACCESS_EXPIRE=$ACCESS_EXPIRE
                        export REFRESH_TOKEN=$REFRESH_TOKEN
                        export REFRESH_EXPIRE=$REFRESH_EXPIRE
                        export CLOUDINARY_NAME=$CLOUDINARY_NAME
                        export CLOUDINARY_API_KEY=$CLOUDINARY_API_KEY
                        export CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET

                        npm run dev &
                        sleep 10
                        pkill -f "node" || true
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            echo "✅ Build successful, server stopped!"
        }
        failure {
            echo "❌ Build failed. Check logs."
        }
    }
}
