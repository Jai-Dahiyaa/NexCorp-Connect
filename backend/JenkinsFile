pipeline {
  agent any
  

  stages {
    stage ('Checkout Code') {
      steps {
        echo "Checking out code..."
        checkout scm
      }
    }

    stage ('install Dependencies') {
      steps {
        echo "Running npm install..."
        dir('backend') {
          sh 'npm ci'
        }
      }
    }

    stage ('dbc console Test') {
      steps {
        echo "Running npm test with env vars..."
        dir('backend') {
          withEnv([
            "DB_HOST=${params.DB_HOST}",
            "DB_USER=${params.DB_USER}",
            "DB_PASS=${params.DB_PASS}",
            "DB_NAME=${params.DB_NAME}",
            "DB_PORT=${params.DB_PORT}"
          ]) {
            sh '''
              echo "üîç DB_HOST=$DB_HOST"
              echo "üîç DB_USER=$DB_USER"
              echo "üîç DB_PASS=$DB_PASS"
              echo "üîç DB_NAME=$DB_NAME"
              echo "üîç DB_PORT=$DB_PORT"
              npm test
            '''
          }
        }
      }
    }

    stage ('Run Test') {
      steps {
        echo "Running npm test..."
        dir('backend') {
          sh 'npm test'
        }
      }
    }

    stage ('Start Project') {
      steps {
        echo "Starting project..."
        dir('backend') {
          sh 'npm run dev'
        }
      }
    }
  }

  post {
    success {
      echo "Build and run successfull"
    } 
    failure {
      echo "Build faild. Check logs"
    }
  }
}